

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Introduction &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel  documentation" href="../index.html"/>
        <link rel="next" title="Kernel modules" href="kernel_modules.html"/>
        <link rel="prev" title="Exercises" href="exercises.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.15.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lectures/so2.cs.pub.ro.html">Sisteme de operare 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="vm.html">Virtual Machine Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercises.html">Exercises</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lab-objectives">Lab objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="#keywords">Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="#about-this-laboratory">About this laboratory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#source-code-navigation">Source code navigation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cscope">cscope</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#kscope">Kscope</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#lxr-cross-reference">LXR Cross-Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sourceweb">SourceWeb</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#debugging">Debugging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gdb-linux">gdb (Linux)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-a-stack-trace">Getting a stack trace</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id1">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exercices">Exercices</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#remarks">Remarks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#booting-the-virtual-machine">1. Booting the virtual machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-and-using-a-virtual-disk">2. Adding and using a virtual disk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gdb-and-qemu">3. GDB and QEMU</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gdb-spelunking">4. GDB spelunking</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cscope-spelunking">5. Cscope spelunking</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="kernel_modules.html">Kernel modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="kernel_api.html">Kernel API</a></li>
<li class="toctree-l1"><a class="reference internal" href="device_drivers.html">Character device drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="interrupts.html">I/O access and Interrupts</a></li>
<li class="toctree-l1"><a class="reference internal" href="deferred_work.html">Deferred work</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory_mapping.html">Memory mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="device_model.html">Linux Device Model</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Introduction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/labs/introduction.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<div class="section" id="lab-objectives">
<h2>Lab objectives<a class="headerlink" href="#lab-objectives" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>presenting the rules and objectives of the Operating Systems 2 lab</li>
<li>introducing the lab documentation</li>
<li>introducing the Linux kernel and related resources</li>
</ul>
</div>
<div class="section" id="keywords">
<h2>Keywords<a class="headerlink" href="#keywords" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>kernel, kernel programming</li>
<li>Linux, vanilla, <a class="reference external" href="http://www.kernel.org">http://www.kernel.org</a></li>
<li>cscope, LXR</li>
<li>gdb, /proc/kcore, addr2line, dump_stack</li>
</ul>
</div>
<div class="section" id="about-this-laboratory">
<h2>About this laboratory<a class="headerlink" href="#about-this-laboratory" title="Permalink to this headline">¶</a></h2>
<p>The Operating Systems 2 lab is a kernel programming and driver development lab.
The objectives of the laboratory are:</p>
<ul class="simple">
<li>deepening the notions presented in the course</li>
<li>presentation of kernel programming interfaces (kernel API)</li>
<li>gaining documenting, development and debugging skills on a freestanding
environment</li>
<li>acquiring knowledge and skills for drivers development</li>
</ul>
<p>A laboratory will present a set of concepts, applications and commands
specific to a given problem. The lab will start with a presentation
(each lab will have a set of slides) (15 minutes) and the remaining
time will be allocated to the lab exercises (80 minutes).</p>
<p>For best laboratory performance, we recommend that you read the related slides.
To fully understand a laboratory, we recommend going through the lab support. For
in-depth study, use the supporting documentation.</p>
</div>
<div class="section" id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Linux<ul>
<li><a class="reference external" href="http://www.amazon.com/Linux-Kernel-Development-Robert-Love/dp/0672329468/">Linux Kernel Development, 3rd
Edition</a></li>
<li><a class="reference external" href="http://free-electrons.com/doc/books/ldd3.pdf">Linux Device Drivers, 3rd
Edition</a></li>
<li><a class="reference external" href="http://www.amazon.com/Essential-Device-Drivers-Sreekrishnan-Venkateswaran/dp/0132396556">Essential Linux Device
Drivers</a></li>
</ul>
</li>
<li>General<ul>
<li><a class="reference external" href="http://cursuri.cs.pub.ro/cgi-bin/mailman/listinfo/pso">mailing list</a>
(<a class="reference external" href="http://blog.gmane.org/gmane.education.region.romania.operating-systems-design">searching the mailing list</a>)</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="source-code-navigation">
<h2>Source code navigation<a class="headerlink" href="#source-code-navigation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="cscope">
<h3>cscope<a class="headerlink" href="#cscope" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://cscope.sourceforge.net/">Cscope</a> is a tool for
efficient navigation of C sources. To use it, a cscope database must
be generated from the existing sources. In a Linux tree, the command
<strong class="command">make ARCH = x86 cscope</strong> is sufficient. Specification of the
architecture through the ARCH variable is optional but recommended;
otherwise, some architecture dependent functions will appear multiple
times in the database.</p>
<p>Cscope can also be used as stand-alone, but it is more useful when
combined with an editor. To use cscope with <strong class="command">vim</strong>, it is necessary to
install both packages and add the following lines to the file
<code class="file docutils literal"><span class="pre">.vimrc</span></code> (the machine in the lab already has the settings):</p>
<div class="highlight-vim"><div class="highlight"><pre><span></span><span class="k">if</span> has<span class="p">(</span><span class="s2">&quot;cscope&quot;</span><span class="p">)</span>
<span class="c">        &quot; Look for a &#39;cscope.out&#39; file starting from the current directory,</span>
<span class="c">        &quot; going up to the root directory.</span>
        <span class="k">let</span> s:dirs <span class="p">=</span> split<span class="p">(</span>getcwd<span class="p">(),</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">while</span> s:dirs <span class="p">!=</span> []
                <span class="k">let</span> s:<span class="nb">path</span> <span class="p">=</span> <span class="s2">&quot;/&quot;</span> . <span class="k">join</span><span class="p">(</span>s:dirs<span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>filereadable<span class="p">(</span>s:<span class="nb">path</span> . <span class="s2">&quot;/cscope.out&quot;</span><span class="p">))</span>
                        execute <span class="s2">&quot;cs add &quot;</span> . s:<span class="nb">path</span> . <span class="s2">&quot;/cscope.out &quot;</span> . s:<span class="nb">path</span> . <span class="s2">&quot; -v&quot;</span>
                        <span class="k">break</span>
                <span class="k">endif</span>
                <span class="k">let</span> s:dirs <span class="p">=</span> s:dirs[:<span class="m">-2</span>]
        <span class="k">endwhile</span>

        <span class="k">set</span> <span class="nb">csto</span><span class="p">=</span><span class="m">0</span>  <span class="c">&quot; Use cscope first, then ctags</span>
        <span class="k">set</span> <span class="nb">cst</span>     <span class="c">&quot; Only search cscope</span>
        <span class="k">set</span> <span class="nb">csverb</span>  <span class="c">&quot; Make cs verbose</span>

        nmap `<span class="p">&lt;</span>C<span class="p">-</span>\<span class="p">&gt;</span>`s :<span class="k">cs</span> find s `<span class="p">&lt;</span>C<span class="p">-</span>R<span class="p">&gt;</span>`<span class="p">=</span>expand<span class="p">(</span><span class="s2">&quot;`&lt;cword&gt;`&quot;</span><span class="p">)</span>`<span class="p">&lt;</span>CR<span class="p">&gt;</span>``<span class="p">&lt;</span>CR<span class="p">&gt;</span>`
        nmap `<span class="p">&lt;</span>C<span class="p">-</span>\<span class="p">&gt;</span>`<span class="k">g</span> :<span class="k">cs</span> find <span class="k">g</span> `<span class="p">&lt;</span>C<span class="p">-</span>R<span class="p">&gt;</span>`<span class="p">=</span>expand<span class="p">(</span><span class="s2">&quot;`&lt;cword&gt;`&quot;</span><span class="p">)</span>`<span class="p">&lt;</span>CR<span class="p">&gt;</span>``<span class="p">&lt;</span>CR<span class="p">&gt;</span>`
        nmap `<span class="p">&lt;</span>C<span class="p">-</span>\<span class="p">&gt;</span>`<span class="k">c</span> :<span class="k">cs</span> find <span class="k">c</span> `<span class="p">&lt;</span>C<span class="p">-</span>R<span class="p">&gt;</span>`<span class="p">=</span>expand<span class="p">(</span><span class="s2">&quot;`&lt;cword&gt;`&quot;</span><span class="p">)</span>`<span class="p">&lt;</span>CR<span class="p">&gt;</span>``<span class="p">&lt;</span>CR<span class="p">&gt;</span>`
        nmap `<span class="p">&lt;</span>C<span class="p">-</span>\<span class="p">&gt;</span>`<span class="k">t</span> :<span class="k">cs</span> find <span class="k">t</span> `<span class="p">&lt;</span>C<span class="p">-</span>R<span class="p">&gt;</span>`<span class="p">=</span>expand<span class="p">(</span><span class="s2">&quot;`&lt;cword&gt;`&quot;</span><span class="p">)</span>`<span class="p">&lt;</span>CR<span class="p">&gt;</span>``<span class="p">&lt;</span>CR<span class="p">&gt;</span>`
        nmap `<span class="p">&lt;</span>C<span class="p">-</span>\<span class="p">&gt;</span>`<span class="k">e</span> :<span class="k">cs</span> find <span class="k">e</span> `<span class="p">&lt;</span>C<span class="p">-</span>R<span class="p">&gt;</span>`<span class="p">=</span>expand<span class="p">(</span><span class="s2">&quot;`&lt;cword&gt;`&quot;</span><span class="p">)</span>`<span class="p">&lt;</span>CR<span class="p">&gt;</span>``<span class="p">&lt;</span>CR<span class="p">&gt;</span>`
        nmap `<span class="p">&lt;</span>C<span class="p">-</span>\<span class="p">&gt;</span>`<span class="k">f</span> :<span class="k">cs</span> find <span class="k">f</span> `<span class="p">&lt;</span>C<span class="p">-</span>R<span class="p">&gt;</span>`<span class="p">=</span>expand<span class="p">(</span><span class="s2">&quot;`&lt;cfile&gt;`&quot;</span><span class="p">)</span>`<span class="p">&lt;</span>CR<span class="p">&gt;</span>``<span class="p">&lt;</span>CR<span class="p">&gt;</span>`
        nmap `<span class="p">&lt;</span>C<span class="p">-</span>\<span class="p">&gt;</span>`<span class="k">i</span> :<span class="k">cs</span> find <span class="k">i</span> ^`<span class="p">&lt;</span>C<span class="p">-</span>R<span class="p">&gt;</span>`<span class="p">=</span>expand<span class="p">(</span><span class="s2">&quot;`&lt;cfile&gt;`&quot;</span><span class="p">)</span>`<span class="p">&lt;</span>CR<span class="p">&gt;</span>`$`<span class="p">&lt;</span>CR<span class="p">&gt;</span>`
        nmap `<span class="p">&lt;</span>C<span class="p">-</span>\<span class="p">&gt;</span>`<span class="k">d</span> :<span class="k">cs</span> find <span class="k">d</span> `<span class="p">&lt;</span>C<span class="p">-</span>R<span class="p">&gt;</span>`<span class="p">=</span>expand<span class="p">(</span><span class="s2">&quot;`&lt;cword&gt;`&quot;</span><span class="p">)</span>`<span class="p">&lt;</span>CR<span class="p">&gt;</span>``<span class="p">&lt;</span>CR<span class="p">&gt;</span>`

<span class="c">        &quot; Open a quickfix window for the following queries.</span>
        <span class="k">set</span> <span class="nb">cscopequickfix</span><span class="p">=</span>s<span class="p">-,</span><span class="k">c</span><span class="p">-,</span><span class="k">d</span><span class="p">-,</span><span class="k">i</span><span class="p">-,</span><span class="k">t</span><span class="p">-,</span><span class="k">e</span><span class="p">-,</span><span class="k">g</span><span class="p">-</span>
<span class="k">endif</span>
</pre></div>
</div>
<p>The script searches for a file called <code class="file docutils literal"><span class="pre">cscope.out</span></code> in the current directory, or
in parent directories. If <strong class="command">vim</strong> finds this file, you can use the shortcut <code class="code docutils literal"><span class="pre">Ctrl</span> <span class="pre">+]</span></code>
or <code class="code docutils literal"><span class="pre">Ctrl+\</span> <span class="pre">g</span></code> (the combination control-\ followed by g) to jump directly to
the definition of the word under the cursor (function, variable, structure, etc.).
Similarly, you can use <code class="code docutils literal"><span class="pre">Ctrl+\</span> <span class="pre">s</span></code> to go where the word under the cursor is used.</p>
<p>You can take a cscope-enabled <code class="file docutils literal"><span class="pre">.vimrc</span></code> file (also contains other goodies) from
<a class="reference external" href="https://github.com/ddvlad/cfg/blob/master/_vimrc">https://github.com/ddvlad/cfg/blob/master/_vimrc</a>.
The following guidelines are based on this file, but also show basic <strong class="command">vim</strong> commands
that have the same effect.</p>
<p>If there are more than one results (usually there are) you can move between them
using <code class="code docutils literal"><span class="pre">F6</span></code> and <code class="code docutils literal"><span class="pre">F5</span></code> (<code class="code docutils literal"><span class="pre">:ccnext</span></code>  and <code class="code docutils literal"><span class="pre">:cprev</span></code>).
You can also open a new panel showing the results using <code class="code docutils literal"><span class="pre">:copen</span></code>. To close
the panel, use the <code class="code docutils literal"><span class="pre">:cclose</span></code> command.</p>
<p>To return to the previous location, use <code class="code docutils literal"><span class="pre">Ctrl+o</span></code> (o, not zero).
The command can be used multiple times and works even if cscope changed the
file you are currently editing.</p>
<p>To go to a symbol definition directly when <strong class="command">vim</strong> starts, use <code class="code docutils literal"><span class="pre">vim</span> <span class="pre">-t</span> <span class="pre">&lt;symbol_name&gt;</span></code>
(for example <code class="code docutils literal"><span class="pre">vim</span> <span class="pre">-t</span> <span class="pre">task_struct</span></code>). Otherwise, if you started <strong class="command">vim</strong> and want
to search for a symbol by name, use <code class="code docutils literal"><span class="pre">cs</span> <span class="pre">find</span> <span class="pre">g</span> <span class="pre">&lt;symbol_name&gt;</span></code> (for example
<code class="code docutils literal"><span class="pre">cs</span> <span class="pre">find</span> <span class="pre">g</span> <span class="pre">task_struct</span></code>).</p>
<p>If you found more than one results and opened a panel showing all the matches
(using <code class="code docutils literal"><span class="pre">:copen</span></code>) and you want to find a symbol of type structure,
it is recommended to search in the results panel (using <code class="code docutils literal"><span class="pre">/</span></code> – slash)
the character <code class="code docutils literal"><span class="pre">{</span></code> (opening brace).</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>You can get a summary of all the <strong class="command">cscope</strong> commands using <strong class="command">:cs help</strong>.</p>
<p class="last">For more info, use the <strong class="command">vim</strong> built-in help command: <strong class="command">:h cscope</strong> or <strong class="command">:h copen</strong>.</p>
</div>
<p>If you use <strong class="command">emacs</strong>, install the <code class="code docutils literal"><span class="pre">xcscope-el</span></code> package and
add the following lines in <code class="file docutils literal"><span class="pre">~/.emacs</span></code>.</p>
<div class="highlight-vim"><div class="highlight"><pre><span></span><span class="p">(</span>require ‘xcscope<span class="p">)</span>
<span class="p">(</span><span class="k">cscope</span><span class="p">-</span>setup<span class="p">)</span>
</pre></div>
</div>
<p>These commands will activate cscope for the C and C++ modes automatically.
<code class="code docutils literal"><span class="pre">C-s</span> <span class="pre">s</span></code> is the key bindings prefix and <code class="code docutils literal"><span class="pre">C-s</span> <span class="pre">s</span> <span class="pre">s</span></code> is used to
search for a symbol (if you call it when the cursor is over a word,
it will use that). For more details, check <cite>https://github.com/dkogan/xcscope.el</cite></p>
<div class="section" id="kscope">
<h4>Kscope<a class="headerlink" href="#kscope" title="Permalink to this headline">¶</a></h4>
<p>For a simpler interface, <a class="reference external" href="http://sourceforge.net/projects/kscope/">Kscope</a>
is a cscope frontend which uses QT. It is lightweight, very fast and very
easy to use. It allows searching using regular expressions, call graphs, etc.
Kscope is no longer mantained.</p>
<p>There is also a <a class="reference external" href="https///opendesktop.org/content/show.php/Kscope4?content=156987">port</a>
of version 1.6 for Qt4 and KDE 4 which keeps the integration of the text
editor Kate and is easier to use than the last version on SourceForge.</p>
</div>
</div>
<div class="section" id="lxr-cross-reference">
<h3>LXR Cross-Reference<a class="headerlink" href="#lxr-cross-reference" title="Permalink to this headline">¶</a></h3>
<p>LXR (LXR Cross-Reference) is a tool that allows indexing and
referencing the symbols in the source code of a program using
a web interface. The web interface shows links to
locations in files where a symbol is defined or used. Development website
for LXR is <a class="reference external" href="http://sourceforge.net/projects/lxr">http://sourceforge.net/projects/lxr</a>. Similar tools
are <a class="reference external" href="http://oracle.github.io/opengrok/">OpenGrok</a> and
<a class="reference external" href="http://en.wikipedia.org/wiki/Gonzui">Gonzui</a>.</p>
<p>Although LXR was originally intended for the Linux kernel sources, it is
also used in the sources of <a class="reference external" href="http://lxr.mozilla.org/">Mozilla</a>,
<a class="reference external" href="http://apache.wirebrain.de/lxr/">Apache HTTP Server</a> and
<a class="reference external" href="http://lxr.linux.no/freebsd/source">FreeBSD</a>.</p>
<p>There are a number of sites that use LXR for cross-referencing the
the sources of the Linux kernel, the main site being <a class="reference external" href="http://lxr.linux.no/linux/">the original site of
development</a> which does not work anymore. You can
use <a class="reference external" href="https://elixir.bootlin.com/">https://elixir.bootlin.com/</a>.</p>
<p>LXR allows searching for an identifier (symbol), after a free text
or after a file name. The main feature and, at the same
time, the main advantage provided is the ease of finding the declaration
of any global identifier. This way, it facilitates quick access to function
declarations, variables, macro definitions and the code can be easily
navigated. Also, the fact that it can detect what code areas are affected
when a variable or function is changed is a real advantage in the development
and debugging phase.</p>
</div>
<div class="section" id="sourceweb">
<h3>SourceWeb<a class="headerlink" href="#sourceweb" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://rprichard.github.io/sourceweb/">SourceWeb</a> is a source code indexer
for C and C++. It uses the
<a class="reference external" href="http://clang.llvm.org/docs/IntroductionToTheClangAST.html">framework</a>
provided by the Clang compiler to index the code.</p>
<p>The main difference between cscope and SourceWeb is the fact that SourceWeb
is, in a way, a compiler pass. SourceWeb doesn’t index all the code, but
only the code that was efectively compiled by the compiler. This way, some
problems are eliminated, such as ambiguities about which variant of a function
defined in multiple places is used. This also means that the indexing takes
more time, because the compiled files must pass one more time through
the indexer to generate the references.</p>
<p>Usage example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>make oldconfig
sw-btrace make -j4
sw-btrace-to-compile-db
sw-clang-indexer --index-project
sourceweb index
</pre></div>
</div>
<p><code class="file docutils literal"><span class="pre">sw-btrace</span></code> is a script that adds the <code class="file docutils literal"><span class="pre">libsw-btrace.so</span></code>
library to <code class="code docutils literal"><span class="pre">LD_PRELOAD</span></code>. This way, the library is loaded by
every process started by <code class="code docutils literal"><span class="pre">make</span></code> (basically, the compiler),
registers the commands used to start the processes and generates
a filed called <code class="file docutils literal"><span class="pre">btrace.log</span></code>. This file is then used by
<code class="code docutils literal"><span class="pre">sw-btrace-to-compile-db</span></code> which converts it to a format defined
by clang: <a class="reference external" href="http://clang.llvm.org/docs/JSONCompilationDatabase.html">JSON Compilation Database</a>.
This JSON Compilation Database resulted from the above steps is then
used by the indexer, which makes one more pass through the compiled
source files and generates the index used by the GUI.</p>
<p>Word of advice: don’t index the sources you are working with, but use
a copy, because SourceWeb doesn’t have, at this moment, the capability
to regenerate the index for a single file and you will have to regenerate
the complete index.</p>
</div>
</div>
<div class="section" id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>
<p>Debugging a kernel is a much more difficult process than the debugging
of a program, because there is no support from the operating system.
This is why this process is usually done using two computers, connected
on serial interfaces.</p>
<div class="section" id="gdb-linux">
<h3>gdb (Linux)<a class="headerlink" href="#gdb-linux" title="Permalink to this headline">¶</a></h3>
<p>A simpler debug method on Linux, but with many disadvantages,
is local debugging, using <a class="reference external" href="http://www.gnu.org/software/gdb/">gdb</a>,
the uncompressed kernel image (<code class="file docutils literal"><span class="pre">vmlinux</span></code>) and <code class="file docutils literal"><span class="pre">/proc/kcore</span></code>
(the real-time kernel image). This method is usually used to inspect
the kernel and detect certain inconsistencies while it runs. The
method is useful especially if the kernel was compiled using the
<code class="code docutils literal"><span class="pre">-g</span></code> option, which keeps debug information. Some well-known
debug techniques can’t be used by this method, such as breakpoints
of data modification.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Because <code class="file docutils literal"><span class="pre">/proc</span></code> is a virtual filesystem, <code class="file docutils literal"><span class="pre">/proc/kcore</span></code>
does not physically exist on the disk. It is generated on-the-fly
by the kernel when a program tries to access <code class="file docutils literal"><span class="pre">proc/kcore</span></code>.</p>
<p>It is used for debugging purposes.</p>
<p>From <strong class="command">man proc</strong>, we have:</p>
<div class="last highlight-none"><div class="highlight"><pre><span></span>/proc/kcore
This file represents the physical memory of the system and is stored in the ELF core file format.  With this pseudo-file, and
an unstripped kernel (/usr/src/linux/vmlinux) binary, GDB can be used to examine the current state of any kernel data struc‐
tures.
</pre></div>
</div>
</div>
<p>The uncompressed kernel image offers information about the data structures
and symbols it contains.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>student@eg106$ <span class="nb">cd</span> ~/src/linux
student@eg106$ file vmlinux
vmlinux: ELF <span class="m">32</span>-bit LSB executable, Intel <span class="m">80386</span>, ...
student@eg106$ nm vmlinux <span class="p">|</span> grep sys_call_table
c02e535c R sys_call_table
student@eg106$ cat System.map <span class="p">|</span> grep sys_call_table
c02e535c R sys_call_table
</pre></div>
</div>
<p>The <strong class="command">nm</strong> utility is used to show the symbols in an object or
executable file. In our case, <code class="file docutils literal"><span class="pre">vmlinux</span></code> is an ELF file. Alternately,
we can use the file <code class="file docutils literal"><span class="pre">System.map</span></code> to view information about the
symbols in kernel.</p>
<p>Then we use <strong class="command">gdb</strong> to inspect the symbols using the uncompressed
kernel image. A simple <strong class="command">gdb</strong> session is the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>student@eg106$ <span class="nb">cd</span> ~/src/linux
stduent@eg106$ gdb --quiet vmlinux
Using host libthread_db library <span class="s2">&quot;/lib/tls/libthread_db.so.1&quot;</span>.
<span class="o">(</span>gdb<span class="o">)</span> x/x 0xc02e535c
0xc02e535c <span class="sb">`</span>&lt;sys_call_table&gt;<span class="sb">`</span>:    0xc011bc58
<span class="o">(</span>gdb<span class="o">)</span> x/16 0xc02e535c
0xc02e535c <span class="sb">`</span>&lt;sys_call_table&gt;<span class="sb">`</span>:    0xc011bc58      0xc011482a      0xc01013d3     0xc014363d
0xc02e536c <span class="sb">`</span>&lt;sys_call_table+16&gt;<span class="sb">`</span>: 0xc014369f      0xc0142d4e      0xc0142de5     0xc011548b
0xc02e537c <span class="sb">`</span>&lt;sys_call_table+32&gt;<span class="sb">`</span>: 0xc0142d7d      0xc01507a1      0xc015042c     0xc0101431
0xc02e538c <span class="sb">`</span>&lt;sys_call_table+48&gt;<span class="sb">`</span>: 0xc014249e      0xc0115c6c      0xc014fee7     0xc0142725
<span class="o">(</span>gdb<span class="o">)</span> x/x sys_call_table
0xc011bc58 <span class="sb">`</span>&lt;sys_restart_syscall&gt;<span class="sb">`</span>:       0xffe000ba
<span class="o">(</span>gdb<span class="o">)</span> x/x <span class="p">&amp;</span>sys_call_table
0xc02e535c <span class="sb">`</span>&lt;sys_call_table&gt;<span class="sb">`</span>:    0xc011bc58
<span class="o">(</span>gdb<span class="o">)</span> x/16 <span class="p">&amp;</span>sys_call_table
0xc02e535c <span class="sb">`</span>&lt;sys_call_table&gt;<span class="sb">`</span>:    0xc011bc58      0xc011482a      0xc01013d3     0xc014363d
0xc02e536c <span class="sb">`</span>&lt;sys_call_table+16&gt;<span class="sb">`</span>: 0xc014369f      0xc0142d4e      0xc0142de5     0xc011548b
0xc02e537c <span class="sb">`</span>&lt;sys_call_table+32&gt;<span class="sb">`</span>: 0xc0142d7d      0xc01507a1      0xc015042c     0xc0101431
0xc02e538c <span class="sb">`</span>&lt;sys_call_table+48&gt;<span class="sb">`</span>: 0xc014249e      0xc0115c6c      0xc014fee7     0xc0142725
<span class="o">(</span>gdb<span class="o">)</span> x/x sys_fork
0xc01013d3 <span class="sb">`</span>&lt;sys_fork&gt;<span class="sb">`</span>:  0x3824548b
<span class="o">(</span>gdb<span class="o">)</span> disass sys_fork
Dump of assembler code <span class="k">for</span> <span class="k">function</span> sys_fork:
0xc01013d3 <span class="sb">`</span>&lt;sys_fork+0&gt;<span class="sb">`</span>:        mov    0x38<span class="o">(</span>%esp<span class="o">)</span>,%edx
0xc01013d7 <span class="sb">`</span>&lt;sys_fork+4&gt;<span class="sb">`</span>:        mov    <span class="nv">$0</span>x11,%eax
0xc01013dc <span class="sb">`</span>&lt;sys_fork+9&gt;<span class="sb">`</span>:        push   <span class="nv">$0</span>x0
0xc01013de <span class="sb">`</span>&lt;sys_fork+11&gt;<span class="sb">`</span>:       push   <span class="nv">$0</span>x0
0xc01013e0 <span class="sb">`</span>&lt;sys_fork+13&gt;<span class="sb">`</span>:       push   <span class="nv">$0</span>x0
0xc01013e2 <span class="sb">`</span>&lt;sys_fork+15&gt;<span class="sb">`</span>:       lea    0x10<span class="o">(</span>%esp<span class="o">)</span>,%ecx
0xc01013e6 <span class="sb">`</span>&lt;sys_fork+19&gt;<span class="sb">`</span>:       call   0xc0111aab <span class="sb">`</span>&lt;do_fork&gt;<span class="sb">`</span>
0xc01013eb <span class="sb">`</span>&lt;sys_fork+24&gt;<span class="sb">`</span>:       add    <span class="nv">$0</span>xc,%esp
0xc01013ee <span class="sb">`</span>&lt;sys_fork+27&gt;<span class="sb">`</span>:       ret
End of assembler dump.
</pre></div>
</div>
<p>It can be noticed that the uncompressed kernel image was used as an argument
for <strong class="command">gdb</strong>. The image can be found in the root of the kernel sources
after compilation.</p>
<p>A few commands used for debugging using <strong class="command">gdb</strong> are:</p>
<ul class="simple">
<li><strong class="command">x</strong> (examine) – Used to show the contents of the memory area
whose address is specified as an argument to the command (this address
can be the value of a physical address, a symbol or the address of a
symbol). It can take as arguments (preceded by <code class="code docutils literal"><span class="pre">/</span></code>): the format
to display the data in (<code class="code docutils literal"><span class="pre">x</span></code> for hexadecimal, <code class="code docutils literal"><span class="pre">d</span></code> for
decimal, etc.), how many memory units to display and the size of a
memory unit.</li>
<li><strong class="command">disassemble</strong> - Used to disassemble a function.</li>
<li><strong class="command">p</strong> (print) - Used to evaluate and show the value of an
expression. The format to show the data in can be specified as
an argument (<code class="code docutils literal"><span class="pre">/x</span></code> for hexadecimal, <code class="code docutils literal"><span class="pre">/d</span></code> for decimal, etc.).</li>
</ul>
<p>The analysis of the kernel image is a method of static analysis. If we
want to perform dynamic analysis (analyzing how the kernel runs, not
only its static image) we can use <code class="file docutils literal"><span class="pre">/proc/kcore</span></code>; this is a dynamic
image (in memory) of the kernel.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>student@eg106$ gdb ~/src/linux/vmlinux /proc/kcore
Core was generated by `root=/dev/hda3 ro&#39;.
#0  0x00000000 in ?? ()
(gdb) p sys_call_table
$1 = -1072579496
(gdb) p /x sys_call_table
$2 = 0xc011bc58
(gdb) p /x &amp;sys_call_table
$3 = 0xc02e535c
(gdb) x/16 &amp;sys_call_table
0xc02e535c `&lt;sys_call_table&gt;`:    0xc011bc58      0xc011482a      0xc01013d3     0xc014363d
0xc02e536c `&lt;sys_call_table+16&gt;`: 0xc014369f      0xc0142d4e      0xc0142de5     0xc011548b
0xc02e537c `&lt;sys_call_table+32&gt;`: 0xc0142d7d      0xc01507a1      0xc015042c     0xc0101431
0xc02e538c `&lt;sys_call_table+48&gt;`: 0xc014249e      0xc0115c6c      0xc014fee7     0xc0142725
</pre></div>
</div>
<p>Using the dynamic image of the kernel is useful for detecting <a class="reference external" href="http://en.wikipedia.org/wiki/Rootkit">rootkits</a>.</p>
<ul class="simple">
<li><a class="reference external" href="http://linuxdriver.co.il/ldd3/linuxdrive3-CHP-4-SECT-6.html">Linux Device Drivers 3rd Edition - Debuggers and Related Tools</a></li>
<li><a class="reference external" href="http://www.securityfocus.com/infocus/1811">Detecting Rootkits and Kernel-level Compromises in Linux</a></li>
<li><a class="reference external" href="http://user-mode-linux.sf.net/">User-Mode Linux</a></li>
</ul>
</div>
<div class="section" id="getting-a-stack-trace">
<h3>Getting a stack trace<a class="headerlink" href="#getting-a-stack-trace" title="Permalink to this headline">¶</a></h3>
<p>Sometimes, you will want information about the trace the execution
reaches a certain point. You can determine this information using
<strong class="command">cscope</strong> or LXR, but some function are called from many
execution paths, which makes this method difficult.</p>
<p>In these situations, it is useful to get a stack trace, which can be
simply done using the function <code class="code docutils literal"><span class="pre">dump_stack()</span></code>.</p>
</div>
</div>
<div class="section" id="id1">
<h2>Documentation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Kernel development is a difficult process, compared to user space
programming. The API is different and the complexity of the subsystems
in kernel requires additional preparation. The associated documentation
is heterogeneous, sometimes requiring the inspection of multiple sources
to have a more complete understanding of a certain aspect.</p>
<p>The main advantages of the Linux kernel are the access to sources and
the open development system. Because of this, the Internet offers a
larger number of documentation for kernel.</p>
<p>A few links related to the Linux kernel are shown bellow:</p>
<ul class="simple">
<li><a class="reference external" href="http://kernelnewbies.org">KernelNewbies</a></li>
<li><a class="reference external" href="http://kernelnewbies.org/KernelHacking">KernelNewbies - Kernel Hacking</a></li>
<li><a class="reference external" href="http://www.tldp.org/HOWTO/KernelAnalysis-HOWTO.html">Kernel Analysis - HOWTO</a></li>
<li><a class="reference external" href="http://web.archive.org/web/20090228191439/http://www.linuxhq.com/lkprogram.html">Linux Kernel Programming</a></li>
<li><a class="reference external" href="http://en.wikibooks.org/wiki/Linux_kernel">Linux kernel - Wikibooks</a></li>
</ul>
<p>The links are not comprehensive. Using  <a class="reference external" href="http://www.google.com">The Internet</a> and
<a class="reference external" href="http://lxr.free-electrons.com/">kernel source code</a> is essential.</p>
</div>
<div class="section" id="exercices">
<h2>Exercices<a class="headerlink" href="#exercices" title="Permalink to this headline">¶</a></h2>
<div class="section" id="remarks">
<h3>Remarks<a class="headerlink" href="#remarks" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>Usually, the steps used to develop a kernel module are the
following:<ul>
<li>editing the module source code (on the physical machine);</li>
<li>module compilation (on the physical machine)</li>
<li>generation of the minimal image for the virtual machine.
This image contains the kernel, your module, busybox and
eventually test programs.</li>
<li>starting the virtual machine using QEMU.</li>
<li>running the tests in the virtual machine.</li>
</ul>
</li>
<li>When using cscope, use <code class="file docutils literal"><span class="pre">~/src/linux</span></code>.
If there is no <code class="file docutils literal"><span class="pre">cscope.out</span></code> file, you can generate it using
the command <strong class="command">make ARCH=x86 cscope</strong>.</li>
<li>You can find more details about the virtual machine at
<a class="reference internal" href="vm.html#vm-link"><span class="std std-ref">Virtual Machine Setup</span></a>.</li>
</ul>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Before solving an exercice, <strong>carefully</strong> read all its bullets.</p>
</div>
</div>
<div class="section" id="booting-the-virtual-machine">
<h3>1. Booting the virtual machine<a class="headerlink" href="#booting-the-virtual-machine" title="Permalink to this headline">¶</a></h3>
<p>A summary of the virtual machine infrastructure:</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">~/src/linux</span></code> - Linux kernel sources, needed to
compile modules. The directory contains the file <code class="file docutils literal"><span class="pre">cscope.out</span></code>,
used for navigation in the source tree.</li>
<li><code class="file docutils literal"><span class="pre">~/src/linux/tools/labs/qemu</span></code>- scripts and auxiliary
files used to generate and run the QEMU VM.</li>
</ul>
<p>To start the VM, run <strong class="command">QEMU_DISPLAY=sdl make boot</strong> in the directory <code class="file docutils literal"><span class="pre">~/src/linux/tools/labs</span></code>:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>student@eg106:~$ <span class="nb">cd</span> ~/src/linux/tools/labs
student@eg106:~/src/linux/tools/labs$ <span class="nv">QEMU_DISPLAY</span><span class="o">=</span>sdl make boot
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To access the virtual machine, at the login prompt, enter the
username <code class="code docutils literal"><span class="pre">root</span></code>; there is no need to enter a password.
The virtual machine will start with the permissions of the
root account.</p>
</div>
</div>
<div class="section" id="adding-and-using-a-virtual-disk">
<h3>2. Adding and using a virtual disk<a class="headerlink" href="#adding-and-using-a-virtual-disk" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you don’t have the file <code class="file docutils literal"><span class="pre">mydisk.img</span></code>, you can download
it from the address <a class="reference external" href="http://elf.cs.pub.ro/so2/res/laboratoare/mydisk.img">http://elf.cs.pub.ro/so2/res/laboratoare/mydisk.img</a>.</p>
</div>
<p>In the <code class="file docutils literal"><span class="pre">~/src/linux/tools/labs/qemu</span></code> directory, you have a new virtual
machine disk, in the file <code class="file docutils literal"><span class="pre">mydisk.img</span></code>. We want to add the disk
to the virtual machine and use it within the virtual machine.</p>
<p>Edit the <code class="file docutils literal"><span class="pre">Makefile</span></code> to add the following <code class="code docutils literal"><span class="pre">-drive</span> <span class="pre">file=mydisk.img,format=raw</span></code>
to the <strong class="command">run</strong> target. Run <code class="code docutils literal"><span class="pre">make</span></code> to boot the virtual machine.</p>
<p>Within the virtual machine, configure access to the virtual disk.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">You do not need to manually create the entry for the new disk in <code class="file docutils literal"><span class="pre">/dev</span></code>
because the virtual machine uses <strong class="command">devtmpfs</strong>.</p>
</div>
<p>Create <code class="file docutils literal"><span class="pre">/test</span></code> directory and try to mount the new disk:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mkdir /test
mount /dev/sda /test
</pre></div>
</div>
<p>The reason why we can not mount the virtual disk is because we do not have support in the
kernel for the filesystem with which the <code class="file docutils literal"><span class="pre">mydisk.img</span></code> is formatted. You will need
to identify the filesystem for <code class="file docutils literal"><span class="pre">mydisk.img</span></code> and compile kernel support for that filesystem.</p>
<p>Close the virtual machine (close the QEMU window, you do not need to use another command).
Use the <strong class="command">file</strong> command on the physical machine to find out with which filesystem
the <code class="file docutils literal"><span class="pre">mydisk.img</span></code> file is formatted. You will identify the <strong class="command">btrfs</strong> file system.</p>
<p>You will need to enable <strong class="command">btrfs</strong> support in the kernel and recompile the kernel image.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>If you receive an error while executing the <strong class="command">make menuconfig</strong>
command, you probably do not have the <strong class="command">libncurses5-dev</strong>
package installed. Install it using the command:</p>
<div class="last highlight-none"><div class="highlight"><pre><span></span>sudo apt-get install libncurses5-dev
</pre></div>
</div>
</div>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p>Enter the <code class="file docutils literal"><span class="pre">~/src/linux/</span></code> subdirectory. Run <strong class="command">make menuconfig</strong>
and go to the <em>File systems</em> section. Enable <em>Btrfs filesystem support</em>.
You will need to use the builtin option (not the module), i.e. <strong class="command">&lt;*&gt;</strong> must appear
next to the option (<strong>not</strong> <strong class="command">&lt;M&gt;</strong>).</p>
<p>Save the configuration you have made. Use the default configuration file (<code class="file docutils literal"><span class="pre">config</span></code>).</p>
<p>In the kernel source subdirectory (<code class="file docutils literal"><span class="pre">~/src/linux/</span></code>) recompile using the command:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>make
</pre></div>
</div>
<p>To wait less, you can use the <strong class="command">-j</strong> option run multiple jobs in parallel.
Generally, it is recommended to use <strong class="command">number of CPUs+1</strong>:</p>
<div class="last highlight-none"><div class="highlight"><pre><span></span>make -j5
</pre></div>
</div>
</div>
<p>After the kernel recompilation finishes, <strong>restart</strong> the QEMU virtual machine:
that is, launch the <strong class="command">make</strong> command in the  subdirectory. You
do not need to copy anything, because the <code class="file docutils literal"><span class="pre">bzImage</span></code> file is a symlink to the kernel
image you just recompiled.</p>
<p>Inside the QEMU virtual machine, repeat the <strong class="command">mkdir</strong> and <strong class="command">mount</strong> operations.
With support for the <strong class="command">btrfs</strong> filesystem, now <strong class="command">mount</strong> will finish successfully.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When doing your homework, there is no need to recompile the kernel
because you will only use kernel modules. However, it is important
to be familiar with configuring and recompiling a kernel.</p>
<p class="last">If you still plan to recompile the kernel, make a backup of the bzImage
file (follow the link in ~/src/linux for the full path). This will allow
you to return to the initial setup in order to have an environment
identical to the one used by vmchecker.</p>
</div>
</div>
<div class="section" id="gdb-and-qemu">
<h3>3. GDB and QEMU<a class="headerlink" href="#gdb-and-qemu" title="Permalink to this headline">¶</a></h3>
<p>We can investigate and troubleshoot the QEMU virtual machine in real time.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You can also use the <strong class="command">GDB Dashboard</strong> plugin for a user-friendly interface.
<strong class="command">gdb</strong> must be compiled with Python support.</p>
<p>In order to install it, you can just run:</p>
<div class="last highlight-none"><div class="highlight"><pre><span></span>wget -P ~ git.io/.gdbinit
</pre></div>
</div>
</div>
<p>To do this, we start the QEMU virtual machine first. Then, we can connect
with <strong class="command">gdb</strong> to <strong>a running QEMU virtual machine</strong> using the command</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>make gdb
</pre></div>
</div>
<p>We used the QEMU command with the <strong class="command">-s</strong> parameter, which means
listening to port <code class="code docutils literal"><span class="pre">1234</span></code> from <strong class="command">gdb</strong>. We can do debugging
using a <strong>remote target</strong> for <strong class="command">gdb</strong>. The existing <code class="file docutils literal"><span class="pre">Makefile</span></code>
takes care of the details.</p>
<p>When you attach a debugger to a process, the process is suspended.
You can add breakpoints and inspect the current status of the process.</p>
<p>Attach to the QEMU virtual machine (using the <strong class="command">make gdb</strong> command)
and place a breakpoint in the <code class="code docutils literal"><span class="pre">sys_access</span></code> function using the
following command in the <strong class="command">gdb</strong> console:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>break sys_access
</pre></div>
</div>
<p>At this time, the virtual machine is suspended. To continue executing it (up to the possible call
of the <code class="code docutils literal"><span class="pre">sys_access</span></code> function), use the command:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>continue
</pre></div>
</div>
<p>in the <strong class="command">gdb</strong> console.</p>
<p>At this time, the virtual machine is active and has a usable console.
To make a <code class="code docutils literal"><span class="pre">sys_access</span></code> call, issue a <strong class="command">ls</strong> command.
Note that the virtual machine was again suspended by <strong class="command">gdb</strong>
and the corresponding <code class="code docutils literal"><span class="pre">sys_access</span></code> callback message appeared within the <strong class="command">gdb</strong> console.</p>
<p>Trace code execution using <strong class="command">step</strong> instruction, <strong class="command">continue</strong> or <strong class="command">next</strong>
instruction. You probably do not understand everything that happens, so use commands
such as <strong class="command">list</strong> and <strong class="command">backtrace</strong> to trace the execution.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">At the <strong class="command">gdb</strong> prompt, you can press <strong class="command">Enter</strong>
(without anything else) to rerun the last command.</p>
</div>
</div>
<div class="section" id="gdb-spelunking">
<h3>4. GDB spelunking<a class="headerlink" href="#gdb-spelunking" title="Permalink to this headline">¶</a></h3>
<p>Use <strong class="command">gdb</strong> to display the source code of the function that creates kernel threads
(<code class="code docutils literal"><span class="pre">kernel_thread</span></code>).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You can use GDB for static kernel analysis using, in the kernel source directory,
a command such as:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>gdb vmlinux
</pre></div>
</div>
<p class="last">Go over the <a class="reference external" href="#gdb-linux">gdb (Linux)</a> section of the lab.</p>
</div>
<p>Use <strong class="command">gdb</strong> to find the address of the <code class="code docutils literal"><span class="pre">jiffies</span></code> variable in memory and its contents.
The <code class="code docutils literal"><span class="pre">jiffies</span></code> variable holds the number of ticks (clock beats) since the system started.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p>To track the value of the jiffies variable, use dynamic analysis in <strong class="command">gdb</strong>
by running the command:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>make gdb
</pre></div>
</div>
<p>as in the previous exercise.</p>
<p class="last">Go over the <a class="reference external" href="#gdb-linux">gdb (Linux)</a> section of the lab.</p>
</div>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p>The <code class="code docutils literal"><span class="pre">jiffies</span></code> is a 64-bit variable.
You can see that its address is the same as the <code class="code docutils literal"><span class="pre">jiffies_64</span></code> variable.</p>
<p>To explore the contents of a 64-bit variable, use in the <strong class="command">gdb</strong> console the command:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>x/gx &amp; jiffies
</pre></div>
</div>
<p>If you wanted to display the contents of the 32-bit variable,
you would use in the <strong class="command">gdb</strong> console the command:</p>
<div class="last highlight-none"><div class="highlight"><pre><span></span>x/wx &amp; jiffies
</pre></div>
</div>
</div>
</div>
<div class="section" id="cscope-spelunking">
<h3>5. Cscope spelunking<a class="headerlink" href="#cscope-spelunking" title="Permalink to this headline">¶</a></h3>
<p>Use LXR or cscope in the <code class="file docutils literal"><span class="pre">~/linux/</span></code> directory to discover
the location of certain structures or functions.</p>
<p>Cscope index files are already generated. Use <strong class="command">vim</strong> and other related commands
to scroll through the source code. For example, use the command:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>vim
</pre></div>
</div>
<p>for opening the <strong class="command">vim</strong> editor. Afterwards, inside the editor, use commands such as:</p>
<p><strong class="command">:cs find g task_struct</strong>.</p>
<p>Find the file in which the following data types are defined:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">struct</span> <span class="pre">task_struct</span></code></li>
<li><code class="docutils literal"><span class="pre">struct</span> <span class="pre">semaphore</span></code></li>
<li><code class="docutils literal"><span class="pre">struct</span> <span class="pre">list_head</span></code></li>
<li><code class="docutils literal"><span class="pre">spinlock_t</span></code></li>
<li><code class="docutils literal"><span class="pre">struct</span> <span class="pre">file_system_type</span></code></li>
</ul>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p>For a certain structure, only its name needs to be searched.</p>
<p class="last">For instance, in the case of <strong class="command">struct task_struct</strong>,
search for the <strong class="command">task_struct</strong> string.</p>
</div>
<p>Usually, you will get more matches. To locate the one you are interested in, do the following:</p>
<ol class="arabic simple">
<li>List all matches by using, in <strong class="command">vim</strong>, <strong class="command">:copen</strong> command.</li>
<li>Look for the right match (where the structure is defined) by looking for an open character
(<strong class="command">{</strong>), a single character on the structure definition line. To search for the open
braid you use in <strong class="command">vim</strong> the construction <strong class="command">/{</strong>.</li>
<li>On the respective line, press <strong class="command">Enter</strong> to get into the source code where the variable
is defined.</li>
<li>Close the secondary window using the command: <strong class="command">:cclose</strong> command.</li>
</ol>
<p>Find the file in which the following global kernel variables are declared:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">sys_call_table</span></code></li>
<li><code class="docutils literal"><span class="pre">file_systems</span></code></li>
<li><code class="docutils literal"><span class="pre">current</span></code></li>
<li><code class="docutils literal"><span class="pre">chrdevs</span></code></li>
</ul>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p>To do this, use a <strong class="command">vim</strong> command with the syntax:</p>
<p><strong class="command">:cs f g &lt;symbol&gt;</strong></p>
<p class="last">where <strong class="command">&lt;symbol&gt;</strong> is the name of the symbol being searched.</p>
</div>
<p>Find the file in which the following functions are declared:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">copy_from_user</span></code></li>
<li><code class="docutils literal"><span class="pre">vmalloc</span></code></li>
<li><code class="docutils literal"><span class="pre">schedule_timeout</span></code></li>
<li><code class="docutils literal"><span class="pre">add_timer</span></code></li>
</ul>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p>To do this, use a <strong class="command">vim</strong> command with the syntax:</p>
<p><strong class="command">:cs f g &lt;symbol&gt;</strong></p>
<p class="last">where <strong class="command">&lt;symbol&gt;</strong> is the name of the symbol being searched.</p>
</div>
<p>Scroll through the following sequence of structures:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">struct</span> <span class="pre">task_struct</span></code></li>
<li><code class="docutils literal"><span class="pre">struct</span> <span class="pre">mm_struct</span></code></li>
<li><code class="docutils literal"><span class="pre">struct</span> <span class="pre">vm_area_struct</span></code></li>
<li><code class="docutils literal"><span class="pre">struct</span> <span class="pre">vm_operations_struct</span></code></li>
</ul>
<p>That is, you access a structure and then you find fields with the data type of the
next structure, access the respective fields and so on.
Note in which files these structures are defined; this will be useful to the following labs.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p>In order to search for a symbol in <strong class="command">vim</strong> (with <strong class="command">cscope</strong> support)
when the cursor is placed on it, use the <strong class="command">Ctrl+]</strong> keyboard shortcut.</p>
<p>To return to the previous match (the one before search/jump), use the
<strong class="command">Ctrl+o</strong> keyboard shortcut.</p>
<p class="last">To move forward with the search (to return to matches before <strong class="command">Ctrl+o</strong>),
use the <strong class="command">Ctrl+i</strong> keyboard shortcut.</p>
</div>
<p>Following the above instructions, find and go through the function call sequence:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">bio_alloc</span></code></li>
<li><code class="docutils literal"><span class="pre">bio_alloc_bioset</span></code></li>
<li><code class="docutils literal"><span class="pre">bvec_alloc</span></code></li>
<li><code class="docutils literal"><span class="pre">kmem_cache_alloc</span></code></li>
<li><code class="docutils literal"><span class="pre">slab_alloc</span></code></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Read <a class="reference external" href="#cscope">cscope</a> or <a class="reference external" href="#lxr-cross-reference">LXR Cross-Reference</a> sections of the lab.</p>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="kernel_modules.html" class="btn btn-neutral float-right" title="Kernel modules" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="exercises.html" class="btn btn-neutral" title="Exercises" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>